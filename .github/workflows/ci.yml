name: CI - Tests

on:
  push:
    branches:
      - main
      - "feature/**"
  pull_request:
    branches:
      - main

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install uv
        uses: astral-sh/setup-uv@v2
        with:
          version: "latest"

      - name: Sync dependencies
        run: uv sync --frozen

      - name: Run tests
        run: uv run pytest -v

      - name: Push model to Hugging Face
        if: github.ref == 'refs/heads/main' && success()
        run: |
          pip install huggingface-hub
          python -c "
          from huggingface_hub import upload_file
          import os
          
          token = '${{ secrets.HF_TOKEN }}'
          model_path = 'models/model_p3.joblib'
          
          if os.path.exists(model_path):
            upload_file(
              path_or_fileobj=model_path,
              path_in_repo='model_p3.joblib',
              repo_id='DagueGG/model-machine-learning',
              repo_type='space',
              token=token
            )
            print('✅ Model uploaded to Hugging Face Space')
          else:
            print('⚠️ Model file not found')
          "

      - name: Sync code to Hugging Face Space
        if: github.ref == 'refs/heads/main' && success()
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git remote add hf https://DagueGG:${{ secrets.HF_TOKEN }}@huggingface.co/spaces/DagueGG/model-machine-learning
          git push hf main --force
